name: Process Network Update

on:
  workflow_dispatch:
    inputs:
      survey_data:
        description: 'Survey report JSON (base64 encoded)'
        required: true
        type: string
      update_type:
        description: 'Type of update'
        required: true
        type: choice
        options:
          - survey_reconciliation
          - manual_update
          - bulk_import
      pr_number:
        description: 'Related PR number (optional)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  process-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Decode and validate survey data
        id: validate
        run: |
          echo "${{ inputs.survey_data }}" | base64 -d > /tmp/survey.json
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('/tmp/survey.json', 'utf8'));
            if (!data.samples || !Array.isArray(data.samples)) {
              console.error('Invalid survey format');
              process.exit(1);
            }
            console.log('Survey validated: ' + data.samples.length + ' samples');
          "

      - name: Run reconciliation
        if: inputs.update_type == 'survey_reconciliation'
        run: |
          npm run test
          echo "Reconciliation complete"

      - name: Comment on PR
        if: inputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ inputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Network update processed successfully via GitHub Actions workflow.'
            })

      - name: Summary
        run: |
          echo "### Network Update Processing Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Type**: ${{ inputs.update_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Success" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.pr_number }}" ]; then
            echo "- **Related PR**: #${{ inputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          fi
